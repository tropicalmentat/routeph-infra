---
- name: Configure DB for backend
  hosts: database:api:route_engine:reverse_proxy
  remote_user: rowt_admin
  become: yes

  tasks:
          - name: Add reverse_proxy nginx configuration
            template:
                    src: templates/rowt.j2
                    dest: /etc/nginx/sites-available/rowt
                    owner: root
                    group: root
            when: "'rp' in inventory_hostname"
            notify: "restart nginx"

          - name: Allow API server to access db
            postgresql_pg_hba:
                    dest: /etc/postgresql/12/main/pg_hba.conf
                    contype: host
                    users: rowt_admin
                    source: "{{ hostvars['api']['ansible_facts']['eth0']['ipv4']['address'] }}/32"
                    databases: rowt_db
                    method: md5
            when: "'db' in inventory_hostname"
            notify: "restart postgres"
            
          - name: Add gunicorn environment variables
            become: yes
            template:
                    src: templates/gunicorn_env.j2
                    dest: /var/www/rowt-api/.env
                    owner: rowt_admin
                    group: www-data 
            when: '"api" in inventory_hostname'
            notify: 
                - "restart rowt-api"
                - "daemon-reload"

          - name: Allow postgres service to listen to traffic from API server
            lineinfile:
                    backup: yes
                    path: /etc/postgresql/12/main/postgresql.conf
                    regex: '.*listen_addresses.*'
                    state: present
                    line: "listen_addresses='*'"
            when: "'db' in inventory_hostname"
            notify: "restart postgres"

          - name: Change ownership of api filestructure
            file:
                    path: /var/www/rowt-api
                    state: directory
                    recurse: yes
                    owner: rowt_admin
                    group: www-data
            when: "'api' in inventory_hostname"
            notify: "restart nginx"
          
          - name: Create symbolic link of sites-available to sites-enabled
            become: yes
            file:
                    src: /etc/nginx/sites-available/rowt-api
                    dest: /etc/nginx/sites-enabled/rowt-api
                    owner: root
                    group: root
                    state: link
            when: "'api' in inventory_hostname"
            notify: "restart nginx"

          - name: Add reverse proxy config
            template:
                    src: templates/rowt.j2
                    dest: /etc/nginx/sites-available/rowt
                    owner: root
                    group: root
            when: "'rp' in inventory_hostname"
            notify: "restart nginx"

          - name: Create symbolic link of rowt frontend to sites-enabled
            become: yes
            file:
                    src: /etc/nginx/sites-available/rowt
                    dest: /etc/nginx/sites-enabled/rowt
                    owner: root
                    group: root
                    state: link
            when: "'rp' in inventory_hostname"
            notify: "restart nginx"

  handlers:
          - name: Restart postgres service
            service:
                    name: postgresql
                    state: restarted
            listen: "restart postgres"

          - name: Restart nginx service
            service:
                    name: nginx
                    state: restarted
            listen: "restart nginx"

          - name: Restart rowt-api service
            service:
                    name: rowt-api
                    state: restarted
            listen: "restart rowt-api"

          - name: reload systemd daemon
            systemd:
                    daemon_reload: yes
            listen: "daemon-reload"

# TODO: Configure postgresql.conf
# TODO: Configure reverse proxy configs
# TODO: Add handlers to restart nginx and postgres services
